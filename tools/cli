#! /bin/bash
# CrazyCake Phalcon App CLI [dev only]
# author: Nicolas Pulido <nicolas.pulido@crazycake.cl>

# stop script if an error occurs
set -e

# set project path
PROJECT_PATH="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# app namespace
APP_NAME=${PWD##*/}

# app paths
TOOLS_PATH=$PROJECT_PATH"/.tools/"

# help output
help() {

	echo -e "\033[93m > "$APP_NAME" webapp CLI \033[0m"
	echo -e "\033[95m watch <option>: Runs watcher daemon. Options: --hmr [HMR], --m [mailing]\033[0m"
	echo -e "\033[95m build: build JS & CSS bundles and compile translations. \033[0m"
	echo -e "\033[95m trans: Update translations po file. \033[0m"
	echo -e "\033[95m php: Runs app php CLI. \033[0m"
	echo -e "\033[95m clean: Cleans cache, logs and JS & CSS .rev bundles.\033[0m"
	echo -e "\033[97m > admin commands \033[0m"
	echo -e "\033[95m core: installs/updates core package (requires cc-phalcon project symlink). \033[0m"
	echo -e "\033[95m aws-sync <bucket> <profile>: Syncs S3 CDN bucket with app assets (requires AWS CLI & profiles).\033[0m"
	exit
}

# commands
case "$1" in

watch)

	echo -e "\033[95mRunning gulp watch...\033[0m"

	[[ "$2" = "--m" ]] && gulp watch-m || gulp watch "${@:2}"
;;

build)

	echo -e "\033[95mGulp build task... \033[0m"

	gulp build

	echo -e "\033[95mExecuting container '$APP_NAME' tasks... \033[0m"

	# rev assets in container
	docker exec -it $APP_NAME bash -c 'php /var/www/app/cli/cli.php main revAssets'

	# translations (gettext)
	bash $TOOLS_PATH"translations.bash" build
;;

trans)

	# translations (gettext)
	bash $TOOLS_PATH"translations.bash" find
;;

php)

	echo -e "\033[95mRunning app php CLI... \033[0m"

	docker exec -it $APP_NAME bash -c "php /var/www/app/cli/cli.php main ${@:2}"
;;

clean)

	docker exec -it $APP_NAME bash -c 'find /var/www/storage/cache /var/www/storage/logs -type f \( ! -iname ".*" \) -print0 | xargs -0 rm -f'

	docker exec -it $APP_NAME bash -c 'find /var/www/public/assets -type f \( -iname "*.rev.*" \) -print0 | xargs -0 rm -f'

	echo -e "\033[92mDone! \033[0m"
;;

core)

	bash $TOOLS_PATH"core.bash" "${@:2}"
;;

aws-sync)

	if [ "$2" = "" ]; then
		echo -e "\033[31mbucket name argument missing.\033[0m" && exit
	fi

	if [ "$3" = "" ]; then
		echo -e "\033[31mAWS profile argument missing (~/.aws/credentials).\033[0m" && exit
	fi

	# sync assets
	SYNC_LOCAL_PATH="$PROJECT_PATH/public/assets/"
	SYNC_REMOTE_PATH="s3://$2/assets/"

	echo -e "\033[95mBucket Syncing $SYNC_LOCAL_PATH -> $SYNC_REMOTE_PATH \033[0m"

	aws s3 sync $SYNC_LOCAL_PATH $SYNC_REMOTE_PATH --profile $3 --delete --cache-control max-age=864000 --exclude '*' --include '*.rev.css' --include '*.rev.js'

	# sync images
	SYNC_LOCAL_PATH="$PROJECT_PATH/public/images/"
	SYNC_REMOTE_PATH="s3://$2/images/"

	echo -e "\033[95mBucket Syncing $SYNC_LOCAL_PATH -> $SYNC_REMOTE_PATH \033[0m"

	aws s3 sync $SYNC_LOCAL_PATH $SYNC_REMOTE_PATH --profile $3 --delete --cache-control max-age=864000 --exclude '*.html'

	# sync fonts
	SYNC_LOCAL_PATH="$PROJECT_PATH/public/fonts/"
	SYNC_REMOTE_PATH="s3://$2/fonts/"

	echo -e "\033[95mBucket Syncing $SYNC_LOCAL_PATH -> $SYNC_REMOTE_PATH \033[0m"

	aws s3 sync $SYNC_LOCAL_PATH $SYNC_REMOTE_PATH --profile $3 --delete --cache-control max-age=864000 --exclude '*.html'
;;

# defaults
*)
	help
;;
esac
